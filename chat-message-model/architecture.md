## 1. Conversation과 Message 모델링

### 1.1 개념적 모델

Conversation

- 하나의 대화 맥락을 표현하는 논리적 단위
- 전체 대화의 aggregate root

Message

- Conversation 내부에 포함되어있는 개별 단위
- 독립적인 비즈니스 의미나 생명주기를 가지지 않음

### 1.2 설계 결정: Message Embedded 저장

Message는 Conversation 내부에 embedded document로 저장한다.

### 1.3 결정 근거

이 구조는 문서 지향 데이터베이스에서 일반적으로 권장되는
Embedded Document Pattern에 기반한다.

적합한 이유는 다음과 같다.

- Aggregate 단위 접근
  - Conversation과 Message는 항상 함께 사용됨
  - 분리할 경우 구조 복잡도만 증가
- 조회 패턴 최적화
  - Conversation 전체 또는 메시지 묶음 조회가 대부분
  - Join 또는 lookup 불필요
- 데이터 지역성(Locality)
  - 관련 데이터가 물리적으로 함께 저장됨
  - 읽기 성능 및 캐시 효율 향상
- 명확한 소유권과 생명주기
  - Message는 Conversation에 의해 완전히 소유됨
  - 삭제, 제한, 아카이빙 정책 적용이 쉬움

### 1.4 트레이드오프

- Conversation 문서 크기 증가 가능성
- 대응 방안:
  - 메시지 개수 제한
  - conversation 개수 제한
  - 애플리케이션 레벨 페이징 처리

## 2. Snapshot vs Reference 저장 전략

### 2.1 문제 정의

- 연관된 정보(설정, 모델 정보, 외부 엔티티 등)를 저장할 때
- 다음 두 가지 방식 중 하나를 선택해야 한다.
  - Reference(참조) 기반 저장
  - Snapshot(스냅샷) 기반 저장

### 2.2 설계 결정: Snapshot 우선 전략

과거 기록의 일부가 되는 정보는 Snapshot 형태로 저장한다.

### 2.3 결정 근거

Snapshot 전략은 다음과 같은 경우에 적합하다.

- 과거 기록의 불변성이 중요

  - 대화나 로그는 생성 시점의 상태를 유지해야 함

- 참조 대상의 변경 가능성

  - 삭제, 수정, 스키마 변경으로 인한 참조 붕괴 방지

- 읽기 중심 시스템

  - 조회 시 반복적인 lookup 제거

- 단순성과 안정성 우선
  - 컬렉션 간 결합 최소화
  - 장애 전파 가능성 감소

### 2.4 허용된 트레이드오프

- Snapshot 데이터는 최신 상태와 다를 수 있음
- 이는 의도된 비정규화이며, 해당 데이터는 “현재 상태”가 아닌 “당시 상태”를 표현함

## 3. 식별자(ID) 소유권 원칙

### 3.1 기본 원칙

각 시스템은 자신의 식별자를 소유한다.

### 3.2 적용 방식

- Conversation은 내부 ID를 primary key로 사용
- 외부 시스템의 ID는 보조 정보로 저장
- 외부 ID에 도메인 의미를 부여하지 않음

### 3.3 효과

- Bounded Context 명확화
- 외부 시스템 변경에 대한 내성 확보
- 디버깅 및 추적 가능성 향상

## 4. 설정 및 Prompt 정보 보존

#### 4.1 설계 결정

설정 및 Prompt 정보는 불변 스냅샷으로 저장한다.

### 4.2 결정 근거

- 재현 가능성
  - 과거 대화 맥락을 명확히 이해 가능
- 설명 가능성
  - 시스템 동작 결과에 대한 근거 제시 가능
- 설정 변경 내성
  - 이후 설정 변경이 과거 데이터에 영향을 주지 않음

## 5. 인덱싱 전략

### 5.1 기본 원칙

- 실제 조회 패턴을 기준으로 설계
- 필터 + 정렬 조합을 고려한 복합 인덱스 우선
- Primary key가 이미 커버하는 필드는 중복 인덱스 제거

## 6. 설계 원칙 요약

| 영역           | 적용 원칙                  |
| -------------- | -------------------------- |
| Message 모델링 | Aggregate 소유 -> Embedded |
| 연관 데이터    | 과거보존 -> smapshot       |
| ID 관리        | 내부 소유권                |
| 설정 정보      | 불변 스냅샷                |
| 인덱싱         | 쿼리 패턴 중심             |

Message 모델링 Aggregate 소유 → Embed

- 연관 데이터 과거 보존 → Snapshot
- ID 관리 내부 소유권
